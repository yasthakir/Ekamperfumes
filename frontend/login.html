<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile OTP Login - Aurora Perfumes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/gsap.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root { --primary: #caa97a; --secondary: #e6d2b2; --bg: #fdfbf7; --card-bg: #ffffff; --text-dark: #2c2c2c; --text-light: #7b6f6a; --danger: #e74c3c; --success: #2ecc71; --shadow-3d: 0 15px 40px rgba(0, 0, 0, 0.15); }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg); color: var(--text-dark); display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .login-container { width: 90%; max-width: 400px; background: var(--card-bg); padding: 40px 30px; border-radius: 20px; box-shadow: var(--shadow-3d); text-align: center; }
        .header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .back-btn { background: none; border: none; font-size: 24px; color: var(--text-dark); cursor: pointer; transition: color 0.3s, transform 0.3s; }
        .back-btn:hover { color: var(--primary); transform: scale(1.1); }
        .logo { font-family: 'Playfair Display', serif; font-size: 36px; font-weight: 700; color: var(--primary); flex-grow: 1; }
        h2 { font-size: 1.7rem; font-weight: 600; margin-bottom: 30px; color: var(--text-dark); }
        .form-panel { transition: opacity 0.4s, transform 0.4s; }
        .form-group { position: relative; margin-bottom: 25px; }
        .form-group .input-group-field { width: 100%; border: 1px solid #ddd; border-radius: 12px; padding: 14px 15px 6px; font-size: 1rem; outline: none; transition: border-color 0.3s; }
        .form-group label { position: absolute; top: 14px; left: 15px; font-weight: 400; color: var(--text-light); pointer-events: none; transition: all 0.3s ease; }
        .form-group .input-group-field:focus + label, .form-group .input-group-field:not(:placeholder-shown) + label { top: 4px; font-size: 0.75rem; color: var(--primary); }
        #otp-section { display: none; }
        #otp-inputs { display: flex; justify-content: space-between; gap: 10px; margin: 20px 0 10px; }
        .otp-box { width: 45px; height: 50px; text-align: center; font-size: 1.5rem; border: 1px solid #ddd; border-radius: 10px; outline: none; transition: all 0.3s ease; }
        .otp-box:focus { border-color: var(--primary); box-shadow: 0 0 8px rgba(202, 169, 122, 0.4); }
        .change-option { text-align: right; margin-top: 5px; }
        .change-option button { background: none; border: none; color: var(--danger); font-size: 0.85rem; cursor: pointer; text-decoration: underline; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 30px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 1.1rem; }
        #send-otp-btn { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: var(--text-dark); margin-top: 10px; }
        #verify-otp-btn { background: var(--success); color: white; margin-top: 10px; }
        .message { margin-top: 20px; padding: 10px; border-radius: 8px; font-weight: 500; }
        .error { background-color: #fcebeb; color: var(--danger); }
        .success { background-color: #e8f9ed; color: var(--success); }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }
        .shake { animation: shake 0.5s ease-in-out; }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="header-controls">
            <button class="back-btn" onclick="window.history.back();"><i class="fas fa-arrow-left"></i></button>
            <div class="logo">Aurora</div>
        </div>
        <h2>Login or Sign Up</h2>
        <form id="login-form">
            <div id="phone-section">
                <div class="form-group">
                    <input type="tel" id="phone-input" class="input-group-field" placeholder=" " maxlength="10" required>
                    <label for="phone-input">Mobile Number (10 Digits)</label>
                </div>
                <button type="button" id="send-otp-btn" class="btn">Send OTP</button>
            </div>
            <div id="otp-section">
                <label>Enter 6-Digit OTP</label>
                <div id="otp-inputs"></div>
                <div class="change-option"><button type="button" id="change-input-btn">Change Number</button></div>
                <div id="otp-timer" style="margin-top: 10px; font-size: 0.9rem;"></div>
                <button type="button" id="verify-otp-btn" class="btn">Verify & Login</button>
            </div>
            <div id="status-message" class="message" style="display: none;"></div>
        </form>
    </div>

 <script>
    // ++ UPDATED: API URL for Railway ++
    const apiBase = "https://ekamperfumes-production.up.railway.app/api";

    let timerInterval;
    let currentMobileNumber = '';

    const phoneSection = document.getElementById('phone-section');
    const phoneInput = document.getElementById('phone-input');
    const sendOtpBtn = document.getElementById('send-otp-btn');
    const otpSection = document.getElementById('otp-section');
    const otpInputsContainer = document.getElementById('otp-inputs');
    const verifyOtpBtn = document.getElementById('verify-otp-btn');
    const statusMessage = document.getElementById('status-message');
    const otpTimerEl = document.getElementById('otp-timer');
    const changeInputBtn = document.getElementById('change-input-btn');

    function showMessage(text, type) { /* ... same code ... */ }
    function startTimer(duration) { /* ... same code ... */ }
    function resendOtp(event) { event.preventDefault(); proceedToOtpStep(true); }
    
    // ++ UPDATED: Calls the live backend URL to send OTP ++
    async function proceedToOtpStep(isResend = false) {
        if (phoneInput.value.length !== 10 || isNaN(phoneInput.value)) {
            showMessage('Please enter a valid 10-digit mobile number.', 'error'); return;
        }
        sendOtpBtn.disabled = true;
        currentMobileNumber = phoneInput.value;
        try {
            const response = await fetch(`${apiBase}/auth/send-otp`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mobile: currentMobileNumber })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.message || 'An error occurred.');
            
            if (!isResend) {
                gsap.timeline()
                    .to(phoneSection, { opacity: 0, y: -20, duration: 0.4, onComplete: () => phoneSection.style.display = 'none' })
                    .set(otpSection, { display: 'block', opacity: 0, y: 20 })
                    .to(otpSection, { opacity: 1, y: 0, duration: 0.4 });
            }
            showMessage(data.message, 'success');
            startTimer(60); 
            document.querySelector('.otp-box').focus();
        } catch (error) {
            showMessage(error.message, 'error');
        } finally {
            sendOtpBtn.disabled = false;
        }
    }

    sendOtpBtn.addEventListener('click', () => proceedToOtpStep(false));
    
    // Create OTP boxes
    for (let i = 0; i < 4; i++) { // Assuming 4-digit OTP from your controller
        const input = document.createElement('input');
        input.type = 'text'; input.className = 'otp-box'; input.maxLength = 1;
        otpInputsContainer.appendChild(input);
        input.addEventListener('input', () => { if (input.value && i < 3) input.nextElementSibling.focus(); });
        input.addEventListener('keydown', (e) => { if (e.key === 'Backspace' && !input.value && i > 0) input.previousElementSibling.focus(); });
    }

    // ++ UPDATED: Calls the live backend URL to verify OTP ++
    verifyOtpBtn.addEventListener('click', async () => {
        let enteredOtp = Array.from(otpInputsContainer.children).map(box => box.value).join('');
        if (enteredOtp.length !== 4) {
            showMessage('Please enter the full 4-digit OTP.', 'error'); return;
        }
        verifyOtpBtn.disabled = true;
        try {
            const response = await fetch(`${apiBase}/auth/verify-otp`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mobile: currentMobileNumber, otp: enteredOtp })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.message || 'Verification failed.');
            
            // Save user data and token to localStorage for other pages to use
            localStorage.setItem('auroraUser', JSON.stringify(data.user));
            localStorage.setItem('auroraToken', data.token);

            showMessage(data.message, 'success');
            clearInterval(timerInterval);
            gsap.to('.login-container', { opacity: 0, scale: 1.1, duration: 0.5, onComplete: () => window.location.href = 'profile.html' });
        } catch (error) {
            showMessage(error.message, 'error');
        } finally {
            verifyOtpBtn.disabled = false;
        }
    });
    
    changeInputBtn.addEventListener('click', () => { /* ... same code ... */ });
</script>
</body>
</html>